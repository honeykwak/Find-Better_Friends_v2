# 유사도 계산 로직 상세 설명 (v3)

이 문서는 `Comprehensive` 모드를 기준으로, 두 검증인 간의 유사도 점수가 어떻게 계산되는지 상세히 설명합니다. 현재 계산식은 '100% 일치율 버그', '기권표의 과도한 페널티', '소수 의견 일치 무시' 문제를 해결한 최신 로직을 반영합니다.

## 최종 계산 공식

유사도 점수는 각 제안의 **가중 평균 동의율**로 계산됩니다.

**최종 가중치 = (ODi + Ci) * Ti**
**유사도 점수 = Σ (Ai * 최종 가중치) / Σ (최종 가중치)**

*   **분자**: 각 제안의 `부분 동의 점수(Ai)`에 `최종 가중치`를 곱한 값의 총합.
*   **분모**: 비교 대상이 되는 모든 제안의 `최종 가중치`의 총합.

---

## 1. 계산의 핵심 구성 요소

### ① 의견 분산 지수 (ODi) - 기본 가중치

각 제안의 기본 가중치 역할을 하며, 투표의 논쟁성을 측정합니다.

*   **핵심 로직**: `ODi`는 정규화된 허핀달-허쉬만 지수(HHI)를 기반으로 계산되며, **Yes, No, Veto, Abstain** 투표를 모두 고려합니다.
*   **Epsilon 가중치**: 모든 제안의 ODi 값에 아주 작은 상수(`EPSILON = 0.01`)가 더해집니다.
    *   **목적**: 어떤 제안도 가중치가 0이 되지 않도록 보장하여, 만장일치 제안에서 불일치했을 때 유사도가 100%로 잘못 나오는 버그를 해결합니다.
*   **수식**: `ODi = (정규화된 HHI) + 0.01`

### ② 소수 의견 일치 보너스 (Ci) - (1차 개선)

두 검증인의 의견 일치가 '소수 의견'에 대한 것일 경우, 해당 일치의 가중치를 증폭시키는 보너스입니다.

*   **목적**: "모두가 Yes라고 할 때 함께 No라고 말하는" 의미 있는 행동의 가치를 제대로 평가합니다.
*   **활성화**: 두 검증인이 **완벽히 동의(`Ai = 1.0`)**했을 때만 보너스가 계산됩니다.
*   **보너스 로직**:
    1.  특정 투표 옵션의 지분율이 **30% 미만**일 경우, '소수 의견'으로 간주합니다.
    2.  이 소수 의견에 대해 일치했다면, 해당 의견의 희소성에 비례하는 보너스가 부여됩니다.
*   **수식**: `Ci = (1 - 해당_소수_의견의_지분율)`. 소수 의견이 아닐 경우 `Ci = 0`.

### ③ 최신성 가중치 (Ti) - "Similarity Options"

'최신성' 옵션 체크박스에 따라 적용 여부가 결정됩니다.

*   **"Apply recency weighting" 체크 시**: `Ti`는 `(제안의 시간순 순위 / 전체 제안 수)`로 계산됩니다.
*   **체크 해제 시**: `Ti`는 모든 제안에 대해 `1`이 되어, 계산에 영향을 주지 않습니다.

### ④ 부분 동의 점수 (Ai) - 기권 처리 로직

두 검증인의 투표 관계를 0과 1 사이의 점수로 변환합니다.

| `voteA` | `voteB` | "Count matching abstentions" | `Ai` 점수 | 설명 |
| :--- | :--- | :--- | :--- | :--- |
| **YES** | **YES** | 무관 | **1.0** | 완전 동의 |
| **NO** | **NO** | 무관 | **1.0** | 완전 동의 |
| **ABSTAIN**| **ABSTAIN**| **ON** | **1.0** | 완전 동의 (기권 일치 인정) |
| **ABSTAIN**| **ABSTAIN**| **OFF** | **0.0** | 완전 불일치 (기권 일치 불인정) |
| **YES** | **NO** | 무관 | **0.0** | 완전 불일치 |
| **YES** | **ABSTAIN**| 무관 | **0.25** | **약한 불일치** |
| **NO** | **ABSTAIN**| 무관 | **0.25** | **약한 불일치** |

---

## 2. `Comprehensive` 모드의 비교 대상 정의

1.  **초기 대상**: 기준 검증인(A) **또는** 비교 검증인(B) 중 **어느 한쪽이라도 투표한 모든 제안**을 초기 비교 대상으로 삼습니다.
2.  **최종 대상**: 두 검증인 모두 투표하지 않은(`NOT_VOTED`) 제안은 이 비교 세계에서 제외됩니다.
