# 유사도 점수 계산 로직 (v2)

이 문서는 검증인 간의 유사도 점수 계산 로직을 설명합니다. 계산 방식은 여러 요소를 기반으로 검증인 간의 관계를 다각적으로 파악하기 위해 설계된 가중 평균 모델입니다.

## 1. 계산의 핵심 요소

최종 점수는 각 제안에 적용되는 세 가지 주요 구성 요소로부터 파생됩니다.

### ① 의견 분산 지수 (ODi) - 새로운 양극화 점수

각 제안의 기본 가중치 역할을 하며, 투표가 얼마나 분산되었는지 또는 논쟁적이었는지를 측정합니다.

*   **목적**: 단순한 찬반 대립을 넘어, 전체 유권자들 사이에서 의견이 크게 갈린 제안에 더 높은 가중치를 부여합니다.
*   **계산**: **Yes, No, Veto, Abstain(기권)** 투표를 모두 포함하는 정규화된 허핀달-허쉬만 지수(HHI)를 사용합니다.
    *   `ODi = 1`은 최대 분산, `ODi = 0`은 완전한 만장일치를 의미합니다.
*   **적용**: 모든 계산 모드에서 **모든 제안의 기본 가중치**로 사용됩니다.

### ② 최신성 가중치 (Ti) - 유사도 옵션

최근 제안에 더 많은 가중치를 부여하는 요소입니다.

*   **활성화**: **"Apply recency weighting to similarity"** 체크박스를 선택했을 때만 적용됩니다. 선택하지 않으면 모든 제안의 `Ti`는 `1`이 됩니다.
*   **공식**: `Ti = (제안의 시간순 순위 / 전체 제안 수)`

### ③ 동의 여부 (Ai) & 기권(Abstain) 예외 규칙

두 검증인이 특정 제안에 동의했는지를 결정합니다. 이 로직은 `Abstain` 투표를 어떻게 처리하는지에 따라 크게 달라집니다.

*   **핵심 아이디어**: `Abstain`은 '의견 불일치'가 아닌 '판단 보류' 또는 '의도적 불참'으로 간주합니다. `Abstain`이 포함된 제안은 점수 왜곡을 피하기 위해 계산에서 제외되는 경우가 많습니다.

*   **예외 규칙**:
    1.  **"Count matching abstentions" 체크박스 선택 시:**
        *   `A: Abstain`, `B: Abstain` -> **동의**로 간주. 제안을 계산에 **포함** (`Ai = 1`).
        *   한쪽만 `Abstain`인 경우 (예: `A: Yes`, `B: Abstain`) -> **매치되지 않음**. 해당 제안을 계산에서 **제외**.
    2.  **"Count matching abstentions" 체크박스 미선택 시:**
        *   **어느 한쪽이라도** `Abstain`에 투표했다면, 해당 제안은 계산에서 **제외**.

*   **일반적인 동의**: `Abstain`이 없는 다른 모든 경우, `voteA === voteB`이면 동의(`Ai = 1`), `voteA !== voteB`이면 비동의(`Ai = 0`)로 처리됩니다.

---

## 2. 정렬 옵션 (계산 모드)

세 가지 유사도 정렬 옵션의 핵심적인 차이는 **계산에 포함되는 제안의 범위("비교 세계")**에 있습니다. 기권 예외 규칙은 이 단계를 적용하기 *전에* 먼저 실행됩니다.

### 모드 1: `Similarity (Common)`

*   **비교 세계**: **두 검증인 모두가 투표하고**, 기권 예외 규칙에 의해 제외되지 않은 제안만 포함.
*   **의미**: "두 검증인이 기권을 제외한 명확한 의견을 냈을 때, 얼마나 자주 일치했는가?"를 측정.

### 모드 2: `Similarity (Base)`

*   **비교 세계**: **기준 검증인이 투표하고**, 기권 예외 규칙에 의해 제외되지 않은 모든 제안을 포함.
*   **의미**: "비교 대상은 기준 검증인의 명확한 입장을 얼마나 잘 따르는가?"를 측정.

### 모드 3: `Similarity (Comprehensive)`

*   **비교 세계**: **두 검증인 중 한 명이라도 투표하고**, 기권 예외 규칙에 의해 제외되지 않은 모든 제안을 포함.
*   **의미**: "두 검증인의 명확한 의사가 표명된 모든 활동을 통틀어, 그들의 입장은 얼마나 일치하는가?"를 측정.

---

## 3. 최종 계산 공식

최종적으로 결정된 "비교 세계" 내의 제안들을 대상으로, 유사도 점수는 **동의 여부에 대한 가중 평균**으로 계산됩니다.

**유사도 점수 = Σ (Ai * ODi * Ti) / Σ (ODi * Ti)**

*   **분자**: 두 검증인이 **동의한** 제안들의 가중치 총합.
*   **분모**: 최종 비교에 포함된 **모든** 제안들의 가중치 총합.
